section:
  name: "Special Configuration Considerations"
  description: |
    The recommendations proposed here try to address some of the less common use
    cases which may warrant additional configuration guidance/consideration.
  number: "8"

controls:
  - id: "8.1"
    title: "Ensure base backups are configured and functional"
    profile_applicability:
      - "Level 1 - Yugabyte"
    description: |
      Backup and restoration is the process of creating and storing copies of your data for
      protection against data loss. With a proper backup strategy, you can always restore
      your data to a most-recent known working state and minimize application downtime.
      This in turn guarantees business and application continuity.
    rationale: |

    audit: |
      Verify snapshots exist by executing the list_snapshots command, as follows:
      ./bin/yb-admin -master_addresses <ip1:7100,ip2:7100,ip3:7100> list_snapshots
      All the snapshots in the cluster are listed, along with their statuses.
      Snapshot UUID State Creation Time
      0d4b4935-2c95-4523-95ab-9ead1e95e794 COMPLETE 2023-04-20
      00:20:38.214201
    remediation: |
      Using distributed snapshots allows you to back up a database and then restore it in
      case of a software or operational error, with minimal recovery time objectives (RTO) and
      overhead.
      To back up a database, create a snapshot using the create_database_snapshot
      command, as follows:
      ./bin/yb-admin -master_addresses <ip1:7100,ip2:7100,ip3:7100>
      create_database_snapshot ysql.<database_name>
      A unique ID for the snapshot is returned, as shown in the following sample output:
      Started snapshot creation: 0d4b4935-2c95-4523-95ab-9ead1e95e794
      You can then use this ID to check the status of the snapshot, delete it, or use it to
      restore the database.
      The create_database_snapshot command exits immediately, but the snapshot may take
      some time to complete. Before using the snapshot, verify its status by executing the
      list_snapshots command, as follows:
      ./bin/yb-admin -master_addresses <ip1:7100,ip2:7100,ip3:7100> list_snapshots
      All the snapshots in the cluster are listed, along with their statuses
    impact: |

    default_value: N/A
    type: "Manual"
    references:
      -
      -
    cis_controls:
      -

  - id: "8.2"
    title: "Ensure YugabyteDB configuration files are outside the data cluster"
    profile_applicability:
      - "Level 1 - Yugabyte"
    description: |
      YugabyteDB configuration files within the data cluster's directory tree can be changed
      by anyone logging into the data cluster as the superuser, i.e. yugabyte. As a matter of
      default policy, configuration files such as ysql_pg.conf, ysql_hba.conf, and pg_ident,
      are placed in the data cluster's directory, $PGDATA. YugabyteDB can be configured to
      relocate these files to locations outside the data cluster which cannot then be altered by
      an ordinary superuser login session.
    rationale: |
      Leaving YugabyteDB configuration files within the data cluster's directory tree increases
      the chances that they will be inadvertently or intentionally altered.
    audit: |
      Execute the following commands to verify the configuration is correct:
      yugabyte=# select name, setting from pg_settings where name ~ '.*_file$';
      name | setting
      --------------------+--------------------------------------------------------
      -
      config_file | /home/user/var/data/pg_data/ysql_pg.conf
      external_pid_file |
      hba_file | /home/user/var/data/pg_data/ysql_hba.conf
      ident_file | /home/user/var/data/pg_data/pg_ident.conf
      ssl_ca_file |
      ssl_cert_file | server.crt
      ssl_crl_file |
      ssl_dh_params_file |
      ssl_key_file | server.key
      (9 rows)
    remediation: |
      Follow these steps to remediate the configuration file locations and permissions:
      • Determine appropriate locations for relocatable configuration files based on your
      organization's security policies. If necessary, relocate and/or rename
      configuration files outside of the data cluster.
      • Ensure their file permissions are restricted as much as possible, i.e. only
      superuser read access.
      • Change the settings accordingly in the ysql_pg.conf configuration file via
      GFLAGs.
      • Restart the database cluster for the changes to take effect.
    impact: |
      
    default_value: |
      The defaults for YugabyteDB configuration files are listed below.
      name | setting
      ----------------------+----------------------------------------
      config_file | /var/lib/pgsql/14/data/ysql_pg.conf
      external_pid_file |
      hba_file | /var/lib/pgsql/14/data/ysql_hba.conf
      ident_file | /var/lib/pgsql/14/data/pg_ident.conf
      promote_trigger_file |
      ssl_ca_file |
      ssl_cert_file | server.crt
      ssl_crl_file |
      ssl_dh_params_file |
      ssl_key_file | server.key
      (10 rows)
    type: "Automated"
    references:
      - 
      - 
    cis_controls:
      - 

  - id: "8.3"
    title: "Ensure YugabyteDB subdirectory locations are outside the data cluster"
    profile_applicability:
      - "Level 1 - Yugabyte"
    description: |
      The YugbayteDB cluster is organized to carry out specific tasks in subdirectories. For
      the purposes of performance, reliability, and security some of these subdirectories
      should be relocated outside the data cluster.
    rationale: |
      Some subdirectories contain information, such as logs, which can be of value to others
      such as developers. Other subdirectories can gain a performance benefit when placed
      on fast storage devices. Finally, relocating a subdirectory to a separate and distinct
      partition mitigates denial of service and involuntary server shutdown when excessive
      writes fill the data cluster's partition, e.g. fs_data_dir, fs_wal_dir and log_dir.
    audit: |
      Execute the following YSQL statement to verify the configuration is correct.
      Alternatively, inspect the parameter settings in the ysql_pg.conf configuration file.
      yugabyte=# select name, setting from pg_settings where (name ~
      '_directory$');
      name | setting
      ----------------------+------------------------------------------------------
      --
      data_directory | /home/user/var/data/pg_data
      default_tablespace |
      log_directory | /home/user/var/data/yb-data/tserver/logs
      stats_temp_directory | pg_stat_tmp
      temp_tablespaces |
      (5 rows)
      Inspect the file and directory permissions for all returned values. Only superusers and
      authorized users should have access control rights for these files and directories. If
      permissions are not highly restrictive, this is a fail.
    remediation: |
      Perform the following steps to remediate the subdirectory locations and permissions:
      • Determine appropriate data, log, and tablespace directories and locations based
      on your organization's security policies. If necessary, relocate all listed directories
      outside the data cluster.
      • Ensure file permissions are restricted as much as possible, i.e. only superuser
      read access.
      • When directories are relocated to other partitions, ensure that they are of
      sufficient size to mitigate against excessive space utilization.
      • Lastly, change the settings accordingly in the ysql_pg.conf configuration file via
      GFLAGs and restart the database cluster for changes to take effect.
    impact: |
      
    default_value: |
      The default for data_directory is ConfigDir and the default for log_directory is log
      (based on absolute path of data_directory).
    type: "Automated"
    references:
      - 
      - 
    cis_controls:
      - 

  - id: "8.4"
    title: "Ensure miscellaneous configuration settings are correct"
    profile_applicability:
      - "Level 1 - Yugabyte"
    description: |
      This recommendation covers non-regular, special files, and dynamic libraries.
      YugabyteDB permits local logins via the UNIX DOMAIN SOCKET and, for the most
      part, anyone with a legitimate Unix login account can make the attempt. Limiting
      YugabyteDB login attempts can be made by relocating the UNIX DOMAIN SOCKET to
      a subdirectory with restricted permissions.
      The creation and implementation of user-defined dynamic libraries is an extraordinary
      powerful capability. In the hands of an experienced DBA/programmer, it can significantly
      enhance the power and flexibility of the RDBMS; but new and unexpected behavior can
      also be assigned to the RDBMS, resulting in a very dangerous environment in what
      should otherwise be trusted.
    rationale: |
      
    audit: |
      Execute the following YSQL statement to verify the configuration is correct.
      Alternatively, inspect the parameter settings in the ysql_pg.conf configuration file.
      yugabyte=# select name, setting from pg_settings where name in
      ('external_pid_file',
      'unix_socket_directories','shared_preload_libraries','dynamic_library_path','
      local_preload_libraries','session_preload_libraries');
      name | setting
      ---------------------------+-------------------------------------------------
      ------
      dynamic_library_path | $libdir
      external_pid_file |
      local_preload_libraries |
      session_preload_libraries |
      shared_preload_libraries |
      pg_stat_statements,yb_pg_metrics,pgaudit,pg_hint_plan
      unix_socket_directories | /tmp/
      (6 rows)
      Inspect the file and directory permissions for all returned values. Only superusers
      should have access control rights for these files and directories. If permissions are not
      highly restricted, this is a fail.
    remediation: |
      Follow these steps to remediate the configuration:
      • Determine permissions based on your organization's security policies.
      • Relocate all files and ensure their permissions are restricted as much as
      possible, i.e. only superuser read access.
      • Ensure all directories where these files are located have restricted permissions
      such that the superuser can read but not write.
      • Lastly, change the settings accordingly in the ysql_pg.conf via GFLAGs and
      restart the database cluster for changes to take effect.
    impact: |
      
    default_value: |
      The dynamic_library_path default is $libdir and unix_socket_directories default is
      /tmp. The default for external_pid_file and all library parameters are initially null, or
      not set, upon cluster creation.
    type: "Automated"
    references:
      - 
      - 
    cis_controls:
      - 
